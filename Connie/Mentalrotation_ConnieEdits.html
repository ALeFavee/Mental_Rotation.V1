<!DOCTYPE html>
<html>

<head>
  <title>Mental Rotation Task</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
</head>

<body></body>
<script>

  // Initialize jsPsych + show progress bar up to
  var jsPsych = initJsPsych({
    show_progress_bar: true,
    on_finish: function() {
      jsPsych.data.get().localSave('csv', 'results.csv'); //save data at the end as a csv file
      jsPsych.data.displayData();
    }
  });

  // Create timeline
  var timeline = [];

  // Preload images
  var preload = {
    type: jsPsychPreload,
    images: [
'stimuli/1_0_R.jpg','stimuli/1_0.jpg','stimuli/48_50.jpg', 'stimuli/48_100_R.jpg','stimuli/48_100.jpg', 'stimuli/48_150_R.jpg', 'stimuli/48_150.jpg'
    ]
  };
  timeline.push(preload);

  const vviqSurvey = {
  type: 'survey-likert',
  preamble: "Think of some relative or friend whom you frequently see (but who is not with you at present) and consider carefully the picture that comes before your mind’s eye.",
  questions: [
    {
      prompt: "The exact contours of face, head, shoulders and body.",
      labels: [
        "No image at all, you only 'know' that you are thinking of the object",
        "Dim and vague; flat",
        "Moderately clear and lively",
        "Clear and lively",
        "Perfectly clear and lively as real seeing",
      ],
    },
    {
      prompt: "Characteristic poses of head, attitudes of body, etc.",
      labels: [
        "No image at all, you only 'know' that you are thinking of the object",
        "Dim and vague; flat",
        "Moderately clear and lively",
        "Clear and lively",
        "Perfectly clear and lively as real seeing",
      ],
    },
    {
      prompt: "The precise carriage, length of step, etc., in walking.",
      labels: [
        "No image at all, you only 'know' that you are thinking of the object",
        "Dim and vague; flat",
        "Moderately clear and lively",
        "Clear and lively",
        "Perfectly clear and lively as real seeing",
      ],
    },
    {
      prompt: "The different colors worn in some familiar clothes.",
      labels: [
        "No image at all, you only 'know' that you are thinking of the object",
        "Dim and vague; flat",
        "Moderately clear and lively",
        "Clear and lively",
        "Perfectly clear and lively as real seeing",
      ],
    },
  ],
};
timeline.push(vviqSurvey);

  /* Adding survey for data collection */

  var VVIQ = {
    type: jsPsychSurveyHtmlForm,
    preamble:'<p>Think of some relative or friend whom you frequently see (but who is not with you at present) and consider carefully the picture that comes before your mind’s eye.</p>',
    html: `
      <label>The exact contours of face, head, shoulders and body. 
        <select name="response" required>
          <option value="" disabled selected>Select your option</option>
          <option value="No image at all, you only “know” that you are thinking of the object">0</option>
          <option value="Dim and vague; flat">1</option>
          <option value="Moderately clear and lively">2</option>
          <option value="Clear and lively">3</option>
          <option value="Perfectly clear and lively as real seeing">4</option>
        </select>
      </label>
    `
  };
  timeline.push(VVIQ);

 // Fullscreen mode
 var enter_fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  };
  timeline.push(enter_fullscreen);
  


  // Welcome message
  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "Welcome to the experiment. Press any key to begin."
  };
  timeline.push(welcome);

  // Participant ID entry
  var participant_id_entry = {
    type: jsPsychSurveyText,
    questions: [
      {prompt: "Please enter your participant ID:", name: 'participant_id'}
    ]
  };
  timeline.push(participant_id_entry);

  //create an array of test images
   var test_images = [
'stimuli/1_0_R.jpg','stimuli/1_0.jpg','stimuli/48_50.jpg', 'stimuli/48_100_R.jpg','stimuli/48_100.jpg', 'stimuli/48_150_R.jpg', 'stimuli/48_150.jpg'
   ];
// Shuffle the test images
var shuffled_test_images = jsPsych.randomization.repeat(test_images, 1);

// Initialize an empty array for trials
var trials = [];

// setting up counter to split length of exp based on image count 
var halfwayPoint = Math.floor(test_images.length / 4)
var counter = 0 

for (let i = 0; i < shuffled_test_images.length; i++) {
  // determining correct response for each image based on "R" or not 
  let correct_response = shuffled_test_images[i].includes("_R") ? 'j' : 'f';
  
  //line below only relevant if we have a trial counter to display
  ///let remainingTrials = shuffled_test_images.length - i;
  
  // mental rotation trial
  var mental_rotation_trial = {
    type: jsPsychImageKeyboardResponse,
    stimulus: shuffled_test_images[i],
    choices: ['f', 'j'],
    prompt: "<p>Press 'f' if the images are the same, 'j' if they are different.</p>" ,
    
    //line below only relevant if we have a trial counter to display
    //+ "<p>Remaining images: " + remainingTrials + "</p>",

    data: { task: "response", correct_response: correct_response },
    on_finish: function(data) {
      data.correct = (data.response == data.correct_response);
      console.log(data.correct);
    }
  };

  // color coded borders around response 
  var feedback = {
    type: jsPsychHtmlKeyboardResponse,
    trial_duration: 500,
    stimulus: function() {
      var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
      return last_trial_correct
        ? '<p style="border: 5px solid green;">Correct!</p>'
        : '<p style="border: 5px solid red;">Incorrect.</p>';
    }
  };

  trials.push(mental_rotation_trial, feedback);

  // checking halfway status 
  if(++counter === halfwayPoint) {
    var break_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p> Take a break! Exp continues in 30 seconds . </p>",
      trial_duration: 30000,
      choices: ['space']
    };
    trials.push(break_trial)
  }
}

// get csv representation of data and log to console
console.log(jsPsych.data.get().csv());
  // run exp
timeline.push(...trials);


  // Final message
  var final_message = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<p>Thank you for participating!</p><p>Press any key to finish.</p>"
  };
  timeline.push(final_message);



    // Exit fullscreen mode
    var exit_fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: false,
    delay_after: 0
  };
  timeline.push(exit_fullscreen);

jsPsych.run(timeline);

</script>
</html>
